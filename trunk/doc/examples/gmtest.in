#!/bin/bash
#
# $Id$
#
# Bash script inclusion to test all GMT examples.
# It sets the environment such that the examples are created as in the manual.

test -z "$1" && exit 1

# Where the current script resides (need absolute path)
script_name="$1"
script_dir=$(dirname "${script_name}")
script="@GMT_SOURCE_DIR@/doc/examples/${script_name}"
if ! [ -x "${script}" ]; then
  echo "error: cannot execute script ${script}." 1>&2
  exit 1
fi

shift

# choose awk
if type gawk 2>&1 >/dev/null ; then
  export AWK=gawk
elif type nawk 2>&1 >/dev/null ; then
  export AWK=nawk
else
  export AWK=awk
fi

# Temporary change LANG to C
LANG=C

# Define variables that are needed *within* test scripts
GMT_SOURCE_DIR="@GMT_SOURCE_DIR@"
EXTRA_FONTS_DIR="@CMAKE_CURRENT_SOURCE_DIR@/ex31/fonts"
GRAPHICSMAGICK="@GRAPHICSMAGICK@"
src="@GMT_SOURCE_DIR@/doc/examples/${script_dir}"

# When running tests with MinGW we need to change 'c:/' to '/c/'
function fix_mingw_path()
{
  if uname | grep -q MINGW ; then
    # MinGW shell
    sed -E 's/([a-zA-Z]):\//\/\1\//g' <<< "$1"
  else
    # not MinGW
    echo "$1"
  fi
}

# Use executables from GMT_BINARY_DIR, fallback to CMAKE_INSTALL_PREFIX/GMT_BINDIR
export PATH=$(fix_mingw_path "@GMT_BINARY_DIR_PATH@:@GMT_SOURCE_DIR@/src:@CMAKE_INSTALL_PREFIX@/@GMT_BINDIR@"):"${PATH}"
unset GMT5_SHAREDIR
export GMT_SHAREDIR="@GMT_SOURCE_DIR@/share"
export GMT_USERDIR="@GMT_BINARY_DIR@/share"

# Reset error count
ERROR=0

# Convert PS to PDF
function make_pdf()
{
  pdf="${ps%.ps}.pdf"
  test -f "$ps" || return 1
  gmt ps2raster -Tf -A -P -C-sFONTPATH=${EXTRA_FONTS_DIR} "$ps" || ((++ERROR))
  test -f "$pdf" || ((++ERROR))
}

# Compare the ps file with its original.
pscmp () {
test -f "$ps" || return 1
if ! [ -x "$GRAPHICSMAGICK" ]; then
  echo "[PASS] (without comparison)"
  return
fi
for ps in *.ps ; do
  # syntax: gm compare [ options ... ] reference-image [ options ... ] compare-image [ options ... ]
  rms=$("${GRAPHICSMAGICK}" compare -density 200 -maximum-error 0.001 -highlight-color magenta -highlight-style assign -metric rmse -file "${ps%.ps}.png" "$ps" "${src}/${ps}") || pscmpfailed="yes"
  rms=$(sed -nE '/Total:/s/ +Total: ([0-9.]+) .+/\1/p' <<< "$rms")
  if [ -z "$rms" ]; then
    rms="NA"
  else
    rms=$(printf "%.3f\n" $rms)
  fi
  if [ "$pscmpfailed" ]; then
    now=$(date "+%F %T")
    echo "${ps}: RMS Error = $rms [FAIL]"
    echo "$now ${ps}: RMS Error = $rms" >> "@CMAKE_CURRENT_BINARY_DIR@/fail_count.d"
    make_pdf "$ps" # try to make pdf file
    ((++ERROR))
  else
    test -z "$rms" && rms=NA
    echo "${ps}: RMS Error = $rms [PASS]"
  fi
done
}

# Make sure to cleanup at end
function cleanup()
{
  cd "@CMAKE_CURRENT_BINARY_DIR@" # get out of exec_dir before removing it test
  test "$ERROR" -eq 0 && rm -rf "$exec_dir"
  echo "exit status: $ERROR"
  exit $ERROR
}

# Test the output image before exiting
function on_exit()
{
  set +e
  trap - EXIT # Restore EXIT trap
  pscmp
  cleanup
}
trap on_exit EXIT

# Catch other errors
set -e
function on_err()
{
  set +e
  trap - EXIT ERR SIGSEGV SIGTRAP SIGBUS # Restore trap
  ((++ERROR))
  cleanup
}
trap on_err ERR SIGSEGV SIGTRAP SIGBUS

# Create a temporary directory exec_dir in the build dir
# Then copy all of its contents (except *.ps files)
# Run remainder of this GMT script there
exec_dir="@CMAKE_CURRENT_BINARY_DIR@/${script_dir}"
rm -rf "$exec_dir"
mkdir -p "$exec_dir"
cd "$exec_dir"
GLOBIGNORE="*.ps:*.sh" # fonts
ln -fs "$src"/* .
unset GLOBIGNORE

# Start with proper GMT defaults
gmt gmtset -Du FORMAT_TIME_STAMP "Version 5"

# Now run the original script
. "${script}"

# vim: ft=sh
