%------------------------------------------
%	$Id$
%
%	The GMT Documentation Project
%	Copyright (c) 2000-2012.
%	P. Wessel, W. H. F. Smith, R. Scharroo, and J. Luis
%------------------------------------------
%

\chapter{The GMT Vector Data Format for OGR Compatibility}
\label{app:Q}
\thispagestyle{headings}

\section{Background}
\index{OGR}
\index{GDAL}
\index{Aspatial data}
The National Institute for Water and Atmospheric Research (NIWA) in
New Zealand has funded the implementation of a \GMT\ driver (read and
write) for the OGR package. OGR is an Open Source toolkit for accessing
or reformatting vector (spatial) data stored in a variety of formats and
is part of the \htmladdnormallinkfoot{GDAL framework}{http://www.gdal.org}.
The intention was to enable the easy rendering (using \GMT) of spatial
data held in non-\GMT\ formats, and the export of vector data (e.g.,
contours) created by \GMT\ for use with other GIS and mapping packages.
While \progname{ogr2ogr} has had the capability to write this new format
since 2009, \GMT\ 4 did not have the capability to use the extra information.

\GMT\ 5 now allows for more advanced vector data, including donut
polygons (polygons with holes) and aspatial attribute data. At the
same time, the spatial data implementation will not disrupt older
\GMT\ 4 programs since all the new information are written via comments.

The identification of spatial feature types in \GMT\ files generally follows the
\htmladdnormallinkfoot{ESRI shapefile}{http://www.esri.com/library/whitepapers/pdfs/shapefile.pdf}
technical description, (which is largely consistent with the OGC SFS specification).
This specification provides for non-topological point, line and polygon (area)
features, as well as multipoint, multiline and multipolygon features, and was written
by Brent Wood (\href{mailto:b.wood@niwa.co.nz}{b.wood@niwa.co.nz}) based on input
from Paul Wessel and others on the \GMT\ list.

\section{The OGR/GMT format}

Several key properties of the OGR/GMT format is summarized below:

\begin{itemize}
\item All new data fields are stored as comment lines, i.e., in lines starting
with a ``\#''.  OGR/GMT files are therefore compatible with \GMT\ 4 binaries,
which will simply ignore this new information.

\item  To be consistent with current practice in \GMT, data fields are
represented as whitespace-separated strings within the comments, each
identified by the ``@'' character as
a prefix, followed by a single character identifying the content of the
field. To avoid confusion between words and strings, the word (field)
separator within strings will be the ``$|$'' (pipe or vertical bar) character.

\item  Standard UNIX ``$\backslash$'' escaping is used, such as $\backslash$n
for newline in a string.

\item All new data are stored before the spatial data (coordinates) in the
file, so when any \GMT\ 5 program is processing the coordinate data for a
feature, it will already have parsed any non-spatial information for
each feature, which may impact on how the spatial data is treated
(e.g., utilizing the aspatial attribute data for a feature to control
symbology).

\item The first comment line must specify the version of the
OGR/GMT data format, to allow for future changes or enhancements to be
supported by future \GMT\ programs. This document describes v1.0.

\item For consistency with other GIS formats (such as shapefiles) the
OGR/GMT format explicitly contains a field specifying whether the features
are points, linestrings or polygons, or the ``multi'' versions of these.
(Other shapefile feature types will not be supported at this stage). At
present, \GMT\ programs are informed of this via command line parameters.
This will now be explicit in the data file, but does not preclude
command line switches setting symbologies for plotting polygons as
lines (perimeters) or with fills, as is currently the practice.

\item Note that what is currently called a
``multiline'' (multi-segment) file in \GMT\ parlance
is generally a set of ``lines'' in
shapefile/OGR usage. A multiline in this context is a single feature
comprising multiple lines.
For example, all the transects from a particular survey may be stored as
lines, each with it's own attribute set, such as
transect number, date/time, etc. They may also be stored as a single
multiline feature with one attribute set, such as trip ID. This
difference is explicitly stored in the data in OGR/shapefiles, but
currently specified only on the command line in \GMT. This applies also
to points and polygons. The \GMT\ equivalent to
\{multipoint, multiline, multipolygon\} datatypes is multiple \GMT\ files, each
comprising a single \{multipoint, multiline, multipolygon\} feature. 

\item The new \GMT\ vector data files includes a header comment specifying
the type of spatial features it contains, as well as the description of
the aspatial attribute data to be associated with each feature. Unlike
the shapefile format, which stores the spatial and aspatial attribute
data in separate files, the \GMT\ format will store all data in a single
file.

\item  All the features in a \GMT\ file must be of the same type.
\end{itemize}

\section{OGR/GMT Metadata}

Several pieces of metadata information must be present in the header of the OGR/GMT file,
followed by both spatial and aspatial data.  In this section we look at the metadata.

\subsection{Format version}

The comment header line will include a version identifier providing for
possible different versions in future.  It is indicated by the \textbf{@V} sequence.

\begin{table}[h]
\small
\centering
\begin{tabular}{|l|l|l|} \hline
V & GMT1.0 & Data in this file is stored using v1.0 of the OGR/GMT data format \\ \hline
\end{tabular}
\label{tbl:Q1}
\end{table} 
An OGR/GMT file must therefore begin with the line

\begin{verbatim}
# @VGMT1.0
\end{verbatim}
Parsing of the OGR/GMT format is only activated if the version code-sequence has been found.

\subsection{Geometry types}

The words and characters used to specify the geometry type
(preceded by the \textbf{@G} code sequence on
the header comment line), are listed in Table~\ref{tbl:geometries}.
\begin{table}[h]
\small
\centering
\begin{tabular}{|l|l|l|} \hline
\emph{Code}	&	\emph{Geometry}	&	\emph{Description} \\ \hline \hline
G	&	POINT		&	File with point features \\
	&			&	(Each point will have it's own attribute/header line preceding the point coordinates) \\ \hline
G	&	MULTIPOINT	&	File with a single multipoint feature \\
	&			&	(All the point features are a single multipoint, with the same attribute/header \\
	&			&	information) \\ \hline
G	&	LINESTRING	&	File with features comprising multiple single lines  \\
	&			&	(Effectively the current \GMT\ multiline file, each line feature will have it's own  \\ 
	&			&	attribute and header data) \\ \hline
G	&	MULTILINESTRING	&	File with features comprising a multiline \\
	&			&	(All the line features in the file are a single multiline feature, only one attribute\\
	&			&	and header which applies to all the lines) \\ \hline
G	&	POLYGON		&	File with one or more polygons \\
	&			&	(Similar to a line file, except the features are closed polygons) \\ \hline
G	&	MULTIPOLYGON	&	File with a single multipolygon \\
	&			&	(Similar to a \GMT\ multiline file, except the feature is a closed multipolygon) \\ \hline
\end{tabular}
\label{tbl:geometries}
\caption{The geometry types supported by the OGR/GMT.}
\end{table} 
An example \GMT\ polygon file header using this specification (in format 1.0) is

\begin{verbatim}
# @VGMT1.0 @GPOLYGON
\end{verbatim}

\subsection{Domain and map projections}

The new format will also support region and projection information. The
region will be stored in \GMT\ \Opt{R} format (i.e., \Opt{R}\emph{W/E/S/N},
where the \emph{W/E/S/N} values represent the extent of features); the
\textbf{@R} code sequence marks the domain information.
A sample region header is:

\begin{verbatim}
# @R150/190/-45/-54
\end{verbatim}

Projection information will be represented as four optional strings,
prefixed by \textbf{@J} (J being the \GMT\ character for projection information.
The \textbf{@J} code will be followed by a character identifying the format, as shown
in Table~\ref{tbl:projectspec}.

\begin{table}[H]
\small
\centering
\begin{tabular}{|l|l|}  \hline
\emph{Code}	&	\emph{Projection Specification} \\ \hline \hline
@Je	&	EPSG code for the projection \\ \hline
@Jg	&	A string representing the projection parameters as used by \GMT\ \\ \hline
@Jp	&	A string comprising the Proj.4 parameters representing the projection parameters \\ \hline
@Jw	&	A string comprising the OGR WKT (well known text) representation of the projection parameters \\ \hline
\end{tabular}
\label{tbl:projectspec}
\caption{The four ways to specify the map projection parameters.}
\end{table} 

Sample projection strings are:

\begin{verbatim}
# @Je4326 @JgX @Jp"+proj=longlat +ellps=WGS84+datum=WGS84 +no_defs"
# @Jw"GEOGCS[\"WGS84\",DATUM[\"WGS_1984\",SPHEROID\"WGS84\",6378137,\
298.257223563,AUTHORITY[\"EPSG\",\"7030\"]],TOWGS84[0,0,0,0,0,0,0],
AUTHORITY[\"EPSG\",\"6326\"]],PRIMEM[\"Greenwich\",0,\
AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.01745329251994328,\
AUTHORITY[\"EPSG\",\"9122\"]],AUTHORITY[\"EPSG\",\"4326\"]]"
\end{verbatim}

Note that an OGR-generated file will not have a \textbf{@Jg} string, as OGR does
not have any knowledge of the \GMT\ projection specification format. 
\GMT\ supports at least one of the other formats to provide interoperability with other Open Source
related GIS software packages. One relatively simple approach, (with
some limitations), would be a lookup table matching EPSG codes to \GMT\ strings. 

\subsection{Declaration of aspatial fields}

The string describing the aspatial field names associated with the features is
flagged by the \textbf{@N} prefix.

\begin{table}[H]
\small
\centering
\begin{tabular}{|l|l|l|} \hline
N	&	word$|$word$|$word	&	A ``$|$''-separated string of names of the attribute field names \\ \hline
\end{tabular}
\label{tbl:Q3}
\end{table} 
\noindent
Any name containing a space must be quoted.   The \textbf{@N} selection must be combined with a matching string specifying the data type
for each of the named fields, using the \textbf{@T} prefix.
\begin{table}[H]
\small
\centering
\begin{tabular}{|l|l|l|} \hline
T	&	word$|$word$|$word	&		A ``$|$''-separated string of the attribute field data types \\ \hline
\end{tabular}
\label{tbl:Q4}
\end{table} 
\noindent
Available datatypes should largely follow the shapefile (DB3)
specification, including \textbf{string}, \textbf{integer}, \textbf{double},
\textbf{datetime}, and \textbf{logical} (boolean).
In OGR/GMT vector files, they will be stored as appropriately formatted text strings. 

An example header record containing all these is
\begin{verbatim}
# @VGMT1.0 @GPOLYGON @Nname|depth|id @Tstring|double|integer
\end{verbatim}

\section{OGR/GMT Data}

All generic fields must be at the start of the file before
any feature-specific content (feature attribute data follow the
metadata, as do the feature coordinates, separated by a comment line
comprising ``\# FEATURE\_DATA''.
Provided each string is formatted as specified, and occurs on a line
prefixed with ``\#'' (i.e., is a
comment), the format is free form, in that as many comment lines as
desired may be used, with one or more parameter strings in any order in
any line. E.g., one parameter per line, or all parameters on one line.

\subsection{Embedding aspatial data}

Following this header line is the data itself, both aspatial and
spatial. For line and polygon (including multiline and multipolygon)
data, features are separated using a predefined character, by default
``{\textgreater}''. For point (and
multipoint) data, no such separator is required. The comment line
containing the aspatial data for each feature will immediately precede
the coordinate line(s). Thus in the case of lines and polygons, it will
immediately follow the ``{\textgreater}'' line. The data
line will be a comment flag (``\#'') followed by \textbf{@D}, followed by a string of
``$|$''-separated words comprising the data fields defined in the header record. 

To allow for names and values containing spaces, such string items among
the \textbf{@N} or \textbf{@D} specifiers must be enclosed in double quotes.
(Where double quotes or pipe characters are included in the string,
they must be escaped using ``$\backslash$''). Where any
data values are null, they will be represented as no characters between
the field separator, (e.g., \#@D$|$$|$$|$).  A Sample header and corresponding
data line for points are

\begin{verbatim}
# @VGMT1.0 @GPOINT @Nname|depth|id @Tstring|double|integer
# @D"Point 1"|-34.5|1
\end{verbatim}
\noindent
while for a polygon it may look like
\begin{verbatim}
# @VGMT1.0 @GPOLYGON @Nname|depth|id @Tstring|double|integer
>
# @D"Area 1"|-34.5|1
\end{verbatim}

\subsection{Polygon topologies}

New to \GMT\ is the concept of polygon holes.
Most other formats do support this structure, so that a polygon is
specified as a sequence of point defining the perimeter, optionally
followed by similar coordinate sequences defining any holes (the
``donut'' polygon concept). 

To implement this in a way which is compatible with previous \GMT versions,
each polygon feature must be able to be identified as the
outer perimeter, or an inner ring (hole). This is done using a \textbf{@P} or \textbf{@H}
on the data comment preceding the polygon coordinates. The \textbf{@P} specifies
a new feature boundary (perimeter), any following \textbf{@H} polygons are
holes, and must be within the preceding \textbf{@P} polygon (as described in the
shapefile specification). Any \textbf{@H} polygons will NOT have any \textbf{@D} values,
as the aspatial attribute data pertain to the entire feature, the \textbf{@H}
polygons are not new polygons, but are merely a continuation of the
definition of the same feature.

\section{Examples}

Sample point, line and polygon files are (the new data structures are in
lines starting with ``\#'' in
strings prefixed with ``@)''.  Here is a typical point file:

\begin{verbatim}
# @VGMT1.0 @GPOINT @Nname|depth|id
# @Tstring|double|integer
# @R178.43/178.5/-57.98/-34.5
# @Je4326
# @Jp"+proj=longlat +ellps=WGS84 +datum=WGS84+no_defs"
# FEATURE_DATA
# @D"point 1"|-34.5|1
178.5 -45.7
# @D"Point 2"|-57.98|2
178.43 -46.8
...
\end{verbatim}

Next is an example of a line file:

\begin{verbatim}
# @VGMT1.0 @GLINESTRING @Nname|depth|id
# @Tstring|double|integer
# @R178.1/178.6/-48.7/-45.6
# @Jp"+proj=longlat +ellps=WGS84 +datum=WGS84+no_defs"
# FEATURE_DATA
> -W0.25p
# @D"Line 1"|-50|1
178.5 -45.7
178.6 -48.2
178.4 -48.7
178.1 -45.6
> -W0.25p
# @D"Line 2"|-57.98|$
178.43 -46.8
...
\end{verbatim}

Finally we show an example of a polygon file:

\begin{verbatim}
# @VGMT1.0 @GPOLYGON @N"Polygon name"|substrate|id @Tstring|string|integer
# @R178.1/178.6/-48.7/-45.6
# @Jj@Jp"+proj=longlat +ellps=WGS84 +datum=WGS84+no_defs"
# FEATURE_DATA
> -Gblue -W0.25p
# @P
# @D"Area 1"|finesand|1
178.1 -45.6
178.1 -48.2
178.5 -48.2
178.5 -45.6
178.1 -45.6
>
# @H
# First hole in the preceding perimeter, so is technically still
# part of the same geometry, despite the preceding > character.
# No attribute data is provided, as this is inherited.
178.2 -45.4
178.2 -46.5
178.4 -46.5
178.4 -45.4
178.2 -45.4
>
# @P
...
\end{verbatim}
