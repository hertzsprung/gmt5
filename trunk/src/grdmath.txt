#include "common_options.txt"
.TH GRDMATH 1 MANDATE GMT_STRING "Generic Mapping Tools"
.SH NAME
grdmath \- Reverse Polish Notation calculator for grid files
.SH SYNOPSIS
BD(grdmath) [ GMT_I_OPT ] [ OPT(M) ] [ OPT(N) ] [ GMT_Rgeo_OPT ] [ GMT_V_OPT ] 
[ GMT_bi_OPT ] [ GMT_fi_OPT ] [ GMT_h_OPT ] [ GMT_h_OPT ] [ GMT_i_OPT ] [ GMT_n_OPT ] [ GMT_r_OPT ]
IT(operand) [ IT(operand) ] BD(OPERATOR) [ IT(operand) ] BD(OPERATOR) ... BD(=) IT(outgrdfile)
.SH DESCRIPTION
BD(grdmath) will perform operations like add, subtract, multiply, and divide
on one or more grid files or constants using Reverse Polish Notation (RPN)
syntax (e.g., Hewlett-Packard calculator-style).  Arbitrarily complicated expressions
may therefore be evaluated; the final result is written to an output grid file.
When two grids are on the stack, each element in file A is modified by the corresponding element in file B.
However, some operators only require one operand (see below).  If no grid files are used in the
expression then options OPT(R), OPT(I) must be set (and optionally GMT_r_OPT).  The expression
BD(=) IT(outgrdfile) can occur as many times as the depth of the stack allows.
.SH REQUIRED ARGUMENTS
.TP
IT(operand)
If IT(operand) can be opened as a file it will be read as a grid file.  If not a file, it is interpreted
as a numerical constant or a special symbol (see below).
.TP
IT(outgrdfile)
The name of a 2-D grid file that will hold the final result.
(See GRID FILE FORMATS below).
.SH OPTIONAL ARGUMENTS
#include "explain_-I.txt"
.TP
OPT(M)
By default any derivatives calculated are in z_units/ x(or y)_units.
However, the user may choose this option to convert dx,dy in degrees of
longitude,latitude into meters using a flat Earth approximation, so that
gradients are in z_units/meter.
.TP
OPT(N)
Turn off strict domain match checking when multiple grids are manipulated [Default will insist
that each grid domain is within 1e-4 * grid_spacing of the domain of the first grid listed].
#include "explain_-R.txt"
#include "explain_-V.txt"
#include "explain_-bi.txt"
The binary input option only applies to the data files needed by operators BD(LDIST), BD(PDIST),
and BD(INSIDE).
#include "explain_-f.txt"
#include "explain_-g.txt"
#include "explain_-h.txt"
#include "explain_-icols.txt"
#include "explain_-n.txt"
#include "explain_nodereg.txt"
Only used with OPT(R) OPT(I).
#include "explain_help.txt"
.SH OPERATORS
#include "grdmath_man.i"
.SH SYMBOLS
The following symbols have special meaning:
.br
.sp
BD(PI)	3.1415926...
.br
BD(E )	2.7182818...
.br
BD(EULER )	0.5772156...
.br
BD(XMIN )	Minimum x value
.br
BD(XMAX )	Maximum x value
.br
BD(XINC )	x increment
.br
BD(NX )	The number of x nodes
.br
BD(YMIN )	Minimum y value
.br
BD(YMAX )	Maximum y value
.br
BD(YINC )	y increment
.br
BD(NY )	The number of y nodes
.br
BD(X )	Grid with x-coordinates
.br
BD(Y )	Grid with y-coordinates
.br
BD(Xn )	Grid with normalized [-1 to +1] x-coordinates
.br
BD(Yn )	Grid with normalized [-1 to +1] y-coordinates
.SH NOTES ON OPERATORS
(1) The operator BD(SDIST) calculates spherical distances between the (lon, lat)
point on the stack and all node positions in the grid.  The grid domain
and the (lon, lat) point are expected to be in degrees.  Similarly, the BD(SAZ) and BD(SBAZ)
operators calculate spherical azimuth and back-azimuths in degrees, respectively.
The operators BD(LDIST) and BD(PDIST) also computes spherical distances (if OPT(fg) is set),
else they return Cartesian distances.
Note: If the current BD(PROJ_ELLIPSOID) is not spherical then geodesics are used in spherical calculations.
.br
.sp
(2) The operator BD(PLM) calculates the associated Legendre polynomial
of degree L and order M (0 <= M <= L), and its argument is the sine of the latitude.
BD(PLM) is not normalized and includes the Condon-Shortley phase (-1)^M.
BD(PLMg) is normalized in the way that is most commonly used in geophysics.
The C-S phase can be added by using -M as argument.
BD(PLM) will overflow at higher degrees, whereas BD(PLMg) is stable until ultra high degrees (at
least 3000).
.br
.sp
(3) The operators BD(YLM) and BD(YLMg) calculate normalized spherical harmonics for degree L and
order M (0 <= M <= L) for all positions in the grid, which is assumed to be in degrees.
BD(YLM) and BD(YLMg) return two grids, the real (cosine) and imaginary (sine) component
of the complex spherical harmonic.  Use the BD(POP) operator (and BD(EXCH)) to
get rid of one of them, or save both by giving two consecutive = file.nc calls.
.br
The orthonormalized complex harmonics BD(YLM) are most commonly used in physics and seismology.
The square of BD(YLM) integrates to 1 over a sphere.
In geophysics, BD(YLMg) is normalized to produce unit power when averaging the cosine and sine terms
(separately!) over a sphere (i.e. their squares each integrate to 4 pi).
The Condon-Shortley phase (-1)^M is not included in BD(YLM) or BD(YLMg), but it can be added by using -M
as argument.
.br
.sp
(4) All the derivatives are based on central finite differences, with natural boundary conditions.
.br
.sp
(5) Files that have the same names as some operators, e.g., BD(ADD), BD(SIGN), BD(=), etc. should be
identified by prepending the current directory (i.e., ./LOG).
.br
.sp
(6) Piping of files is not allowed.
.br
.sp
(7) The stack depth limit is hard-wired to 100.
.br
.sp
(8) All functions expecting a positive radius (e.g., BD(LOG), BD(KEI), etc.) are passed the
absolute value of their argument.
#include "explain_float.txt"
#include "explain_grd_inout.txt"
#include "explain_grd_coord.txt"
.SH MACROS
Users may save their favorite operator combinations as macros via the file .grdmath
in their current or user directory.  The file may contain any number of macros (one
per record); comment lines starting with # are skipped.  The format for the macros is
BD(name) = BD(arg1 arg2 ... arg2) : IT(comment)
where BD(name) is how the macro will be used.  When this operator appears on the command
line we simply replace it with the listed argument list.  No macro may call another macro.
As an example, the following macro expects three arguments (radius x0 y0) and sets the
modes that are inside the given circle to 1 and those outside to 0:
.sp
INCIRCLE = CDIST EXCH DIV 1 LE : usage: r x y INCIRCLE to return 1 inside circle
.SH EXAMPLES
To take log10 of the average of 2 files, use
.br
.sp
grdmath file1.nc file2.nc ADD 0.5 MUL LOG10 = file3.nc
.br
.sp
Given the file ages.nc, which holds seafloor ages in m.y., use the relation
depth(in m) = 2500 + 350 * sqrt (age) to estimate normal seafloor depths:
.br
.sp
grdmath ages.nc SQRT 350 MUL 2500 ADD = depths.nc
.br
.sp
To find the angle a (in degrees) of the largest principal stress from the stress tensor given by the
three files s_xx.nc s_yy.nc, and s_xy.nc from the relation tan (2*a) = 2 * s_xy / (s_xx - s_yy), use
.br
.sp
grdmath 2 s_xy.nc MUL s_xx.nc s_yy.nc SUB DIV ATAN2 2 DIV = direction.nc
.br
.sp
To calculate the fully normalized spherical harmonic of degree 8 and order
4 on a 1 by 1 degree world map, using the real amplitude 0.4 and the
imaginary amplitude 1.1:
.br
.sp
grdmath -R0/360/-90/90 -I1 8 4 YML 1.1 MUL EXCH 0.4 MUL ADD = harm.nc
.br
.sp
To extract the locations of local maxima that exceed 100 mGal in the file faa.nc:
.br
.sp
grdmath faa.nc DUP EXTREMA 2 EQ MUL DUP 100 GT MUL 0 NAN = z.nc
.br
grd2xyz z.nc -S > max.xyz
.SH REFERENCES
Abramowitz, M., and I. A. Stegun, 1964, IT(Handbook of Mathematical
Functions), Applied Mathematics Series, vol. 55, Dover, New York.
.br
Holmes, S. A., and W. E. Featherstone, 2002, A unified approach to the Clenshaw summation and the
recursive computation of very high degree and order normalised associated Legendre functions.
IT(Journal of Geodesy), 76, 279-299.
.br
Press, W. H.,  S. A. Teukolsky, W. T. Vetterling, and B. P. Flannery, 1992, 
IT(Numerical Recipes), 2nd edition, Cambridge Univ., New York.
.br
Spanier, J., and K. B. Oldman, 1987,
IT(An Atlas of Functions), Hemisphere Publishing Corp.
.SH "SEE ALSO"
.IR gmt (1),
.IR gmtmath (1),
.IR grd2xyz (1),
.IR grdedit (1),
.IR grdinfo (1),
.IR xyz2grd (1)
